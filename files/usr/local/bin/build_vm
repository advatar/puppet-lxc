#!/bin/bash

#
# My interactive script they build a lxc vm
#

echo -n "VM name : "
read VM
echo -n "Virtual Mac addr : "
read MAC
echo -n "IP failover : "
read IP

mkdir -p /var/lib/lxc/$VM
lvcreate -L 4G -n $VM vg00
mkreiserfs /dev/vg00/$VM
echo "/dev/mapper/vg00-$VM   /var/lib/lxc/$VM       reiserfs        defaults        0       2" >> /etc/fstab
mount -a
/usr/lib/lxc/templates/lxc-debian -p /var/lib/lxc/$VM

cat <<EOF >> /var/lib/lxc/$VM/config
# Config réseau
lxc.utsname = $VM
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = br0
lxc.network.name = eth0
lxc.network.ipv4 = $IP
lxc.network.veth.pair = veth$VM
lxc.network.hwaddr = $MAC	
EOF

GW=$(hostname -i | sed -e 's/\([^.]*$\)/254/g')
cat <<EOF > /var/lib/lxc/$VM/rootfs/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
	address $IP
	netmask 255.255.255.255
	broadcast $IP
	post-up route add $GW dev eth0
	post-up route add default gw $GW
	post-down route del $GW dev eth0
	post-down route del default gw $GW
EOF

pwgen
chroot /var/lib/lxc/$VM/rootfs/ passwd
debconf-get-selections | grep "^locales" > /var/lib/lxc/$VM/rootfs/tmp/preseed.txt
chroot /var/lib/lxc/$VM/rootfs/ debconf-set-selections < /tmp/preseed.txt
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y locales
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y puppet
