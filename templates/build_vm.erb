#!/bin/bash

#
# My interactive script they build a lxc vm
#

echo "Création d'un container LXC "
echo -n "name : "
read VM
echo -n "Mac addr : "
read MAC
echo -n "IP : "
read IP

mkdir -p /var/lib/lxc/$VM
lvcreate -L 4G -n $VM vg00
mkreiserfs /dev/vg00/$VM
echo "/dev/mapper/vg00-$VM   /var/lib/lxc/$VM       reiserfs        defaults        0       2" >> /etc/fstab
mount -a
/usr/lib/lxc/templates/lxc-debian -p /var/lib/lxc/$VM

cat <<EOF >> /var/lib/lxc/$VM/config
# /var/lib/lxc/$VM/config
#
lxc.tty = 4
lxc.pts = 1024
lxc.rootfs = /var/lib/lxc/$VM/rootfs
lxc.cgroup.devices.deny = a
# /dev/null and zero
lxc.cgroup.devices.allow = c 1:3 rwm
lxc.cgroup.devices.allow = c 1:5 rwm
# consoles
lxc.cgroup.devices.allow = c 5:1 rwm
lxc.cgroup.devices.allow = c 5:0 rwm
lxc.cgroup.devices.allow = c 4:0 rwm
lxc.cgroup.devices.allow = c 4:1 rwm
# /dev/{,u}random
lxc.cgroup.devices.allow = c 1:9 rwm
lxc.cgroup.devices.allow = c 1:8 rwm
lxc.cgroup.devices.allow = c 136:* rwm
lxc.cgroup.devices.allow = c 5:2 rwm
# rtc
lxc.cgroup.devices.allow = c 254:0 rwm

# mounts point
lxc.mount.entry=proc /var/lib/lxc/$VM/rootfs/proc proc nodev,noexec,nosuid 0 0
lxc.mount.entry=devpts /var/lib/lxc/$VM/rootfs/dev/pts devpts defaults 0 0
lxc.mount.entry=sysfs /var/lib/lxc/$VM/rootfs/sys sysfs defaults  0 0

# Config réseau
lxc.utsname = $VM
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = br0
lxc.network.name = eth0
lxc.network.ipv4 = $IP
lxc.network.veth.pair = veth$VM
lxc.network.hwaddr = $MAC	
# memory
lxc.cgroup.memory.limit_in_bytes = 512M
EOF

<% if hebergeur == "ovh" %>
GW=$(hostname -i | sed -e 's/\([^.]*$\)/254/g')
<% else %>
GW=$(hostname -i)
<% end %>
DOMAIN=$(hostname -d)
cat <<EOF > /var/lib/lxc/$VM/rootfs/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
	address $IP
	netmask 255.255.255.255
	broadcast $IP
	post-up route add $GW dev eth0
	post-up route add default gw $GW
	post-down route del $GW dev eth0
	post-down route del default gw $GW
EOF

cat <<EOF > /var/lib/lxc/$VM/rootfs/etc/hosts
127.0.0.1       localhost
127.0.1.1       $VM.$DOMAIN   $VM

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff04::2 ip6-allrouters
ff02::3 ip6-allhosts
EOF

chroot /var/lib/lxc/$VM/rootfs/ passwd
cp /etc/locale.gen /var/lib/lxc/$VM/rootfs/etc/locale.gen
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y locales
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y --force-yes puppet
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y --force-yes lsb-release
lxc-start -n $VM -d

