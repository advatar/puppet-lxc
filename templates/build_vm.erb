#!/bin/bash

#
# My interactive script they build a lxc vm
#

echo "Création d'un container LXC "
echo -n "name : "
read VM
echo -n "Mac addr : "
read MAC
echo -n "IP : "
read IP

mkdir -p /var/lib/lxc/$VM
lvcreate -L 4G -n $VM vg00
mkreiserfs /dev/vg00/$VM
echo "/dev/mapper/vg00-$VM   /var/lib/lxc/$VM       reiserfs        defaults        0       2" >> /etc/fstab
mount -a
/usr/lib/lxc/templates/lxc-debian -p /var/lib/lxc/$VM

cat <<EOF >> /var/lib/lxc/$VM/config
# Config réseau
lxc.utsname = $VM
lxc.network.type = veth
lxc.network.flags = up
lxc.network.link = br0
lxc.network.name = eth0
lxc.network.ipv4 = $IP
lxc.network.veth.pair = veth$VM
lxc.network.hwaddr = $MAC	
EOF

<% if hebergeur == "ovh" %>
GW=$(hostname -i | sed -e 's/\([^.]*$\)/254/g')
<% else %>
GW=$(hostname -i)
<% end %>
DOMAIN=$(hostname -d)
cat <<EOF > /var/lib/lxc/$VM/rootfs/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
	address $IP
	netmask 255.255.255.255
	broadcast $IP
	post-up route add $GW dev eth0
	post-up route add default gw $GW
	post-down route del $GW dev eth0
	post-down route del default gw $GW
EOF

cat <<EOF > /var/lib/lxc/$VM/rootfs/etc/hosts
127.0.0.1       localhost
127.0.1.1       $VM.$DOMAIN   $VM

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff04::2 ip6-allrouters
ff02::3 ip6-allhosts
EOF

chroot /var/lib/lxc/$VM/rootfs/ passwd
echo "locales	locales/locales_to_be_generated	multiselect	fr_FR.UTF-8 UTF-8" > /var/lib/lxc/$VM/rootfs/tmp/preseed.txt
chroot /var/lib/lxc/$VM/rootfs/ debconf-set-selections < /tmp/preseed.txt
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y locales
chroot /var/lib/lxc/$VM/rootfs/ apt-get install -y --force-yes puppet
